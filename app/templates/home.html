{% extends 'base.html' %}

{% block title %} Pass Predict {% endblock title %}

{% block content %}

    <header>
        <h1 class="title is-size-1">
            Pass Predict
        </h1>
        <h3 class="subtitle is-size-3">
            See a Satellite!
        </h3>
    </header>

    <main>
        <form
            id="passes-form"
            autocomplete="off"
            method="POST"
            action="{{ url_for('home') }}"
        >
            <!-- Reference: https://github.com/danharrin/alpine-tailwind-components/blob/151fd18324f6a596ad93907e98cc87ca0dc893de/select/index.html -->
            <div
                x-data="locationAutocomplete"
                @click.outside="closeListbox()"
                @keydown.escape="closeListbox()"
                class="form-group"
            >
                <div class="field">
                    <label for="locationSearch" class="label">Location</label>
                    <input
                        x-model="query"
                        name="locationQuery"
                        @input.debounce.50ms="search()"
                        @focus="search()"
                        @keydown.arrow-down="focusNextResult()"
                        @keydown.arrow-up="focusPreviousResult()"
                        @keydown.enter.stop.prevent="selectResult()"
                        type="search"
                        class="input"
                        placeholder="New York, NY"
                        required
                    />
                    <div
                        class="autocomplete-result"
                        x-show="open"
                    >
                        <ul
                        class="autocomplete-result-list"
                        @keydown.arrow-down="focusNextResult()"
                        @keydown.arrow-up="focusPreviousResult()"
                        @keydown.enter.stop.prevent="selectResult()"
                        tabindex="-1"
                        >
                        <template x-for="(item, index) in results" :key="index">
                            <li
                            class="autocomplete-result-item"
                            :id="name + '-result-' + index"
                            @click="selectResult()"
                            @mouseenter="focusedIndex = index"
                            @mouseleave="focusedIndex = null"
                            role="option"
                            :aria-selected="focusedIndex === index"
                            :class="{ 'focused-result' : index === focusedIndex }"
                            x-html="item.name"
                            ></li>
                        </template>
                        </ul>
                    </div>

                    <div class="latlon-result" x-show="(selectedIndex != null) && !open">
                        <span class="latlon">Latitude:</span> <span x-text="getValueFixed('lat', 4)"></span>&deg;
                        &nbsp; &nbsp;
                        <span class="latlon">Longitude:</span> <span x-text="getValueFixed('lon', 4)"></span>&deg;
                    </div>

                </div>

                <input type="hidden" name="lat" :value="getValue('lat')" />
                <input type="hidden" name="lon" :value="getValue('lon')" />
                <input type="hidden" name="h" :value="getValue('h')" />
                <input type="hidden" name="name" :value="getValue('name')" />

                <div class="field">
                    <label for="satid" class="label">Select satellite</label>
                    <span class="select">
                        <select name="satid">
                            {% for satellite in satellites %}
                                <option value={{ satellite.id }}>{{ satellite.name }}</option>
                            {% endfor %}
                        </select>
                    </span>
                </div>
                <input type="hidden" name="satname" value="" />

                <div class="buttons">
                    <button id="submit" type="submit" class="button is-primary mr-5">Submit</button>
                    <button id="reset" class="button">Reset</button>
                </div>

            </div>
        </form>
    </main>

{% endblock content %}

{% block javascript %}
<script>
    const queryLocationAPI = async (search_text) => {
        const response = await fetch("locations/?" + new URLSearchParams({q: search_text}).toString());
        const data = await response.json();
        const locations = data['locations'];
        return locations;
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('locationAutocomplete', () => {
            const config = {
                threshold: 1,
                searchFunction: queryLocationAPI,
            };
            let locationAutocomplete = Passpredict.Autocomplete(config);
            return locationAutocomplete;
        });
    })
</script>
{% endblock javascript %}